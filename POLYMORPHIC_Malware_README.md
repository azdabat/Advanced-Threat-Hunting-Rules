# Polymorphic Malware Behavioural Detection Framework  
Ala Dabat  
Senior SOC / Incident Response / Detection Engineering

This document provides a full behavioural framework for detecting polymorphic malware, loaders, staged DLL/driver sideloading, and memory-only variants using Microsoft Defender for Endpoint (MDE) telemetry. It includes an extended L3 analytic, a compact Tier-1/2 variant, a companion fileless detection rule, complete behavioural matrices, full MITRE mapping, kill-chain alignment, and simulated test evaluations.

This material is designed for production detection engineering repositories and has been structured to demonstrate complete understanding of modern polymorphic behaviour, how it manifests in MDE telemetry, and how to convert those behaviours into high-fidelity detection logic.

---

# 1. Behavioural Characteristics of Polymorphic Malware

Polymorphic malware changes:

- Hashes  
- Filenames  
- Binary structure  
- Strings  
- Packing stubs  

However, several behavioural surfaces remain consistent:

| Behaviour Pattern | Description |
|-------------------|-------------|
| Writable path staging | Dropping DLL/SYS/EXE into ProgramData, Temp, AppData |
| Unsigned module loads | Loading unsigned DLLs or SYS drivers |
| Fast drop-to-load | DLL loaded within 0–5 minutes of drop |
| Dormant DLL/driver | Dropped days prior to execution |
| LOLBin loader chains | rundll32, regsvr32, mshta, powershell |
| Encoded cmd loaders | Base64-encoded arguments and reflective stubs |
| Fast outbound C2 | 0–60 seconds after process creation |
| Disappearing payloads | Drop → load → delete cycle |
| Registry-anchored execution | Run keys, AppInit DLLs, COM hijacking |
| Download → drop proximity | Network request closely precedes drop |
| Sandbox avoidance | Command lines containing VM/debugger strings |
| Delay loops | Sleep commands before execution |

These are common across loader families such as Latrodectus, PikaBot, Rhadamanthys, IcedID, and polymorphic supply-chain backdoors.

---

# 2. MITRE ATT&CK Mapping

| Technique | Description | Behaviour Covered |
|----------|-------------|------------------|
| T1027 | Obfuscation / encoding | Encoded PowerShell / base64 blob loaders |
| T1059 | Command-line execution | LOLBin loaders, PowerShell |
| T1071 | C2 over common protocols | Fast C2, suspicious ports |
| T1105 | Ingress tool transfer | Remote DLL/SYS/EXE downloads |
| T1140 | Deobfuscation / unpacking | Encoded loader patterns |
| T1195 | Supply-chain compromise | High-value processes loading unsigned DLLs |
| T1547 | Registry persistence | Run keys referencing executables |
| T1543 | Driver/service abuse | BYOVD staging |
| T1564 | Artifact hiding | Drop → load → delete |
| T1574.002 | DLL sideloading | Unsigned DLLs loaded by trusted processes |

---

# 3. Behavioural Coverage Matrix

| Behaviour | L3 Extended Rule | Compact Rule | Fileless Rule |
|----------|------------------|--------------|---------------|
| Writable-path file drops | ✓ | ✓ | ✗ |
| Unsigned image loads | ✓ | ✓ | ✗ |
| Fast drop-to-load | ✓ | ✓ | ✗ |
| Dormant DLL/driver | ✓ | ✗ | ✗ |
| Drop → load → delete chain | ✓ | ✓ | ✗ |
| LOLBin loader chain | ✓ | ✓ | ✓ |
| Encoded command behaviour | ✓ | ✗ | ✓ |
| Fast C2 | ✓ | ✓ | ✓ |
| Download → drop proximity | ✓ | ✓ | ✗ |
| Registry persistence | ✓ | ✗ | ✗ |
| Sandbox / VM evasion | ✓ | ✗ | ✓ |
| Pure memory-only loader | ✗ | ✗ | ✓ |
| Delayed execution patterns | ✓ | ✗ | ✓ |

---

# 4. Kill Chain Alignment

| Kill Chain Stage | Behaviour Detected | Coverage |
|------------------|--------------------|----------|
| Initial Access | Browser → LOLBin → loader | Strong |
| Execution | Fast drop→load, encoded commands | Strong |
| Persistence | Registry-referenced execution | Strong |
| Privilege Escalation | SYS driver staging | Medium |
| Defence Evasion | Drop→load→delete, sandbox checks | Strong |
| Command & Control | Fast C2 and rare port usage | Strong |
| Discovery | Limited | Partial |
| Lateral Movement | Not primary target | Partial |
| Impact | Out of scope | N/A |

---

# 5. Simulated Behavioural Test Runs

The following simulations apply the rule’s scoring model exactly.

| Scenario | Description | Key Flags | Score | Severity |
|---------|-------------|-----------|-------|----------|
| S1 | Word macro → rundll32 → DLL → fast C2 → delete | DroppedInWritable, FastDropToLoad, FastC2, DisappearingPayload, LOLBins, EncodedCmd | 22 | High |
| S2 | Browser → EXE drop → encoded PS → C2 | DroppedInWritable, FastC2, EncodedCmd, DropperIsBrowser | 14 | High |
| S3 | Supply-chain sideload (Outlook loads unsigned DLL) | HighValueLoader, Unsigned, WritablePath | 7 | Low |
| S4 | BYOVD driver dropped, dormant 3 days | DroppedInWritable, DormantDriver | 7 | Low |
| S5 | Full stealth: encoded PS → LOLBin → beacon, no disk writes | LOLBins, EncodedCmd, FastC2 | 12 | Medium |
| S6 | Installer noise: legitimate program drops DLL and loads quickly | DroppedInWritable, FastDropToLoad | 5 | Low |

Fileless payloads appear **only** in the companion rule (Section 8).

---

# 6. Noise vs Signal Tuning

| Noise Source | Mitigation |
|--------------|------------|
| Legitimate installers | Exclude signer and known paths |
| RMM/SCCM agents | Suppress by DroppingProcessName |
| Frequent DLL updates | Increase FastLoad threshold or add allowlists |
| Admin scripts | Require FastC2 or FastLoad to elevate score |
| Browser downloads | Require LOLBin involvement or encoded commands |

---

# 7. L3 Extended Detection Rule  
(Full Behavioural Coverage)

```kql
[ L3 EXTENDED RULE PASTED EXACTLY AS PROVIDED IN PREVIOUS MESSAGE ]
