// Windows Kernel EoP Hunt — Low/Medium Integrity → SYSTEM Jumps
// Author: Ala Dabat
// Scope: Hunt for likely kernel privilege escalation chains (2024–2025)
// Data: DeviceProcessEvents, DeviceInfo
// MITRE: TA0004 (Privilege Escalation), TA0005 (Defense Evasion)

let Lookback = 24h;

let SuspiciousStarterProcesses = dynamic([
    "cmd.exe","powershell.exe","pwsh.exe","python.exe",
    "poc.exe","exploit.exe","nc.exe","plink.exe","rundll32.exe"
]);

DeviceProcessEvents
| where Timestamp >= ago(Lookback)
// Normalise key fields
| extend
    SourceUser          = tostring(InitiatingProcessAccountName),
    TargetUser          = tostring(AccountName),
    SourceIntegrity     = tostring(InitiatingProcessIntegrityLevel),
    TargetIntegrity     = tostring(TargetProcessIntegrityLevel),
    SourceProcess       = tostring(InitiatingProcessFileName),
    SourceCmd           = tostring(InitiatingProcessCommandLine),
    TargetProcess       = tostring(FileName),
    TargetCmd           = tostring(ProcessCommandLine)
// Focus on “jump” from low / medium → SYSTEM context
| where SourceIntegrity in ("Low","Medium")
| where TargetIntegrity == "System"
// Ignore normal core SYSTEM processes as the target
| where TargetProcess !in~ ("lsass.exe","winlogon.exe","services.exe","svchost.exe")
// Basic exploit-chain heuristic: suspicious starter tooling or obvious PoC markers
| extend LikelyExploitChain =
    iif(
        SourceProcess in~ (SuspiciousStarterProcesses)
        or SourceCmd has_any ("exploit","poc","cve-2024","cve-2025","kernel"),
        1, 0
    )
| where LikelyExploitChain == 1
// Reduce volume: collapse by device + source process + target process
| summarize
    FirstSeen              = min(Timestamp),
    LastSeen               = max(Timestamp),
    EventCount             = count(),
    ExampleSourceProcess   = any(SourceProcess),
    ExampleSourceCmd       = any(SourceCmd),
    ExampleTargetProcess   = any(TargetProcess),
    ExampleTargetCmd       = any(TargetCmd),
    ExampleSourceUser      = any(SourceUser),
    ExampleTargetUser      = any(TargetUser)
  by DeviceId, DeviceName
// Add device context
| join kind=leftouter (
    DeviceInfo
    | project DeviceId, OSPlatform, DeviceCategory, ExposureLevel, DeviceTags
) on DeviceId
// Simple scoring model
| extend
    BaseScore = 60,
    ServerBoost   = iif(DeviceCategory =~ "Server", 10, 0),
    ExposureBoost = iif(ExposureLevel =~ "High", 10, 0),
    FinalScore = BaseScore + ServerBoost + ExposureBoost,
    Severity = case(
        FinalScore >= 80, "High",
        FinalScore >= 60, "Medium",
        "Low"
    ),
    KillChainStage = "Privilege Escalation (Low/Medium → SYSTEM)",
    MITRE_Tactics  = "TA0004 Privilege Escalation; TA0005 Defense Evasion",
    MITRE_Techniques = "T1068 Exploitation for Privilege Escalation"
| project
    FirstSeen,
    LastSeen,
    EventCount,
    Severity,
    FinalScore,
    KillChainStage,
    DeviceName,
    OSPlatform,
    DeviceCategory,
    ExposureLevel,
    DeviceTags,
    ExampleSourceProcess,
    ExampleSourceCmd,
    ExampleSourceUser,
    ExampleTargetProcess,
    ExampleTargetCmd,
    ExampleTargetUser,
    MITRE_Tactics,
    MITRE_Techniques
| order by Severity desc, LastSeen desc
